# Install the model backend - Siba and add few features to it

You will get a ready full-stack architecture, with Node.js backend written with TypeScript using MariaDB RDBMS. After setting all up you try to follow the model and implement few backend features that:

* include security in form of login created token
* include input validation
* use Knex library to do DB operations

Generic information will be here: 

https://github.com/haagahelia/ohke-teknologiat/tree/master/05_es6_node/NodeJS_demo


## Create the workspace folder

1. Create the root root folder ('Workspace folder') 'Siba'. Somewhere that is not under any git repo folder (repo folders cannot be under other repo folders)

### Install the backend

1. Go to the workspace folder 'Siba'
1. Clone there the backend project repo: https://github.com/haagahelia/Siba_be
1. You will not get the node_modules, so you will need to move to that folder and: ```npm install```
1. Also the .env file is not in repo, so create/copy that given file contents to backend repo root
1. You can also run the: ```npm audit fix```   , if there would be any recent vulnerabilities.
1. Now ´npm start´should start the backend. But without Database connection
1. See the backend logs in 'logs' folder

### Setup database or tunnel to remote database

1. Either install MariaDB locally to your computer, or use the given remote database via tunnel. In any case you need to pay attention to server host address, port, usernames, passwords, database/schema names, ...
1. This console command in Windows would create a ssh tunnel / port forwarding if you will use remote database:
```ssh -f juuser1@128.123.123.45 -L 3308:localhost:3306 -N```
 . The local port in your computer would be 3308, and in the remote computer we would target 3306 where MariaDB database typically exists. **Note**: all info here is incorrect as correct info cannot be published in the github repo. **See Teams for correct information = secrets**. If everything goes correctly this command does not return anything
    i. to see 
1. Backend .env file must match your database: 
    1. The database server (or tunnel) address, typically localhost
    1. The database server (or tunnel) port, typically 3306, 3308, 3315 or so
    1. The database user, in our case could be e.g. jyser3, but you have possibly created something different. Note this is almost never same as a Linux user connecting to the Linux computer
    1. The database user's password. Note it's not the Linux password, but database password
    1. The database/schema name, e.g. casedb, ideacasedb, must be correct too

So just calm down and think through and make sure you have all details correctly.

### Install DBeaver to 1. create DB, 2. insert and 3. read the data in the tables

More info about database connection set up and how to use DBeaver here:

https://github.com/haagahelia/ohke-teknologiat/tree/master/05_es6_node/NodeJS_demo

### Install the frontend

1. Go to the workspace folder 'Siba'
1. Clone there the frontend project repo: https://github.com/haagahelia/siba-fe
1. You will not get the node_modules, so you will need to move to that folder and: ```npm install```
1. Also the .env.local file is not in repo, so create/copy that given file contents to frontend repo root
1. You can also run the: ```npm audit fix```   , if there would be any recent vulnerabilities.
1. ```npm start``` would start the application and with logout/login you can use e.g. email: "admin", password: "admin" to log in.

### Set up the VS Code REST client

1. Add the 'REST Client' add-on to VS Code
1. Create a '.vscode' settings folder to the Siba root root folder. (In file explorer, or e.g. in console/shell/terminal: ```mkdir .vscode```)
1. Copy to that folder the given settings.json file. The tokens there are fake/expired, but you get the structure correct
1. Go to backend 'request' folder, and run the requests in the 1_Logins.rest file. And copy the token you get by running e.g. admin-admin to the settings.json file, adminEnv token. And so on. You can copy the noroleuser token to the expiredEnv, and it will expire in maybe one hour.
1. Now, if you select the REST client environment from the bottom right of the VS Code window. It needs to be selected once, before going to next step
1. ...then you are ready to run other tests in request folder (forget files starting with _ they are in process of being removed)
1. Look at the GlobalSettings as some kind of model. 
1. The nextId variable needs to be changed to the autogenerated id you get by running the POST.

### The additions to write and test in the backend code

You will be adding API end point and routing for all/most of these features:

* what are the database logged events (don't mix it with the logs file and e.g. app.log) there are over all? Easy feature as it needs maybe login, but no input in the request for the query. Database: casedb, Table: log_event

* what rows there are that are mentioning hard-coded subject 4016?

* what rows there are that are mentioning something given in the request. = request should include, in body or URL 'searchText' and if the LIKE % matches, those rows are returned.

* what warnings there are that are from given date? Either use the date part of datetime and match it to given date OR use some time difference function

**Note:** to have data in the log_event table, the logging setting in GlobalSetting table must be 1, and someone must have run the Program results Reset calculation and Start calculation. Well if someone has, and there is data in log_event table, no need to do again.

1. add the file src/routes/logEvent.ts
1. add routing '/logEvent' to that file, in file src/routes/index.ts
1. following the models in e.g. in Subject related route and validation code...
1. add the suggested/required new log_event routes ONE by ONE.
    1. add the endpoint and routing to it
        1. the database operation should be always started by doing something easy that works, and then making it more specific. E.g. first list everything, and only after that works put there WHERE conditions.
    1. add the REST client test for it
    1. add validation components to validationHandler new file logEvent.ts IF needed by that endpoint (e.g. mere GET all does not need any input = no input validation)
    1. if added validation, test it again. Try to make it fail

